<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Glow Bike</title>

    <link rel="stylesheet" type="text/css" href="./third-party/reinvented-color-wheel.min.css">
    <script src="./third-party/reinvented-color-wheel.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="./third-party/tiny-popup-menu.min.css">
    <script src="./third-party/tiny-popup-menu.js"></script>


</head>



<body>



<style>
* {
    box-sizing: border-box;
}

html, body {
    background-color: black;
    border: 0px;
    margin: 0px;
    width: 100%;
    height: 100%;
}
</style>




<script>
let glowBike           = null;
let glowBikeController = null;
</script>
    
<script type="module">
import { BleGlowBike } from "./js/BleGlowBike.js"
glowBike = new BleGlowBike();
</script>
    






<style>

.tinypopup {
    font-size: 1.5rem;
    text-align: left;
}

.menuContainer {
    background-color: black;
    border: 1px solid grey;

    height: 25px;
    width:  25px;

    position: absolute;
    top: 0px;
    left: 0px;

    z-index: 2;

    display: flex;
    flex-direction: column;
    justify-content: space-evenly;
    align-items: center;

    visibility: hidden;
}

.menuBar {
    background-color: grey;
    width: 66%;
    height: 15%;
}

</style>

<div class="menuContainer" id="menu">
    <div class="menuBar"></div>
    <div class="menuBar"></div>
    <div class="menuBar"></div>
</div>

<script>
'strict';

let MENU_HEIGHT;

let domMenu = document.getElementById('menu');
let currentScreen = "";

function SwitchTo(screen)
{
    domMenu.style.visibility = "visible";

    if (screen == currentScreen) return;

    let domConfigurationScreen = document.getElementById("GlowBikeConfigurationScreen");
    let domControlScreen       = document.getElementById("GlowBikeControlScreen");

    if (screen == "Configuration")
    {
        StopGlowBikeControlScreen();
        StartGlowBikeConfigurationScreen();

        domControlScreen.style.zIndex       = 0;
        domConfigurationScreen.style.zIndex = 1;
        domConfigurationScreen.style.visibility = "visible";

        currentScreen = "Configuration";
    }
    else    // Control
    {
        StopGlowBikeConfigurationScreen();
        StartGlowBikeControlScreen();

        domConfigurationScreen.style.zIndex = 0;
        domControlScreen.style.zIndex       = 1;
        domControlScreen.style.visibility = "visible";
        domModal.style.visibility = "visible";

        currentScreen = "Control";
    }
}

function SetupMenu()
{
    // Set up the menu to be the right size
    menu.style.height = `${MENU_HEIGHT}px`;
    menu.style.width  = `${MENU_HEIGHT}px`;

    let tinyPopupMenu = new TinyPopupMenu({
        autoclose: true,
        position: TinyPopupMenu.Position.Bottom,
        margin: 5,
        offset: { x: 0, y: 0 },
        className: 'tinypopup',
        arrow: false,
        menuItems: [
            {
                content: 'Configuration Screen',
                callback: () => {
                    SwitchTo("Configuration");
                },
            },
            {
                content: 'Color Control Screen',
                callback: () => {
                    SwitchTo("Control");
                },
                className: 'disabled',
            },
            '-',
            {
                content: 'Help',
                callback: () => window.open("/app/help", "_blank"),
                className: 'delete'
            }
        ]
    });

    tinyPopupMenu.addToggler(document.getElementById('menu'), {}, 'click');
}

</script>

















<style>
#GlowBikeConfigurationScreen {
    position: absolute;
    top: 0px;
    left: 0px;

    width: 100%;
    height: 100%;

    background-color: white;
    color: black;

    visibility: hidden;
}



</style>

<div id="GlowBikeConfigurationScreen">
    <div id="menuspacer"> </div>
    words
</div>

<script>
'strict';

let domMenuspacer = document.getElementById("menuspacer");

function SetupGlowBikeConfigurationScreen()
{

}

function StartGlowBikeConfigurationScreen()
{
    console.log(`Starting Configuration Screen`);

    domMenuspacer.style.height = MENU_HEIGHT;
}

function StopGlowBikeConfigurationScreen()
{
    console.log(`Stopping Configuration Screen`);
}
</script>


























<style>
    #GlowBikeControlScreen {
        position: absolute;
        top: 0px;
        left: 0px;
    
        width: 100%;
        height: 100%;
    
        background-color: black;

        visibility: hidden;
    }
    
    input[type=checkbox] {
        margin: 0px;
    }
    
    input[type=button] {
        height: 100%;
        font-size: 1.3rem;
        background-color: #555555;
        border: #555555;
        flex: 1;
    }
    
    .flex-vertical {
        display: flex;
        flex-direction: column;
    }
    
    .maximize {
        flex: 1;
    }
    
    .inputRow {
        display: flex;
        flex-direction: row;
        flex: 1;
        align-items: center;
    }
    
    #colorwheel-container {
        flex: 1;
    }
    
    /* specify a little spacing between every element */
    .gap-between {
        gap: 2px;
    }
    
    .placeholder {
        visibility: hidden;
    }
    
    /* Adapted from : https://codepen.io/bgebelein/pen/wvYeapy */
    input[type=range] {
        appearance: none;
        -webkit-appearance: none;
        background-color: rgba(255, 255, 255, 0.3);
        margin: 0;
        padding: 0;
        width: 100%;
        height: 1rem;
        border-radius: 1rem;
        overflow: hidden;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 0;
      box-shadow: -100rem 0 0 100rem rgba(255, 255, 255, 1.0);
    }
    input[type=range]::-moz-range-thumb {
      border: none;
      width: 0;
      box-shadow: -100rem 0 0 100rem rgba(255, 255, 255, 1.0);
    }
    
    /* give specific colors for certain sliders */
    #rRange                       { background-color:              rgba(255,   0,   0, 0.3); }
    #rRange::-webkit-slider-thumb { box-shadow: -100rem 0 0 100rem rgba(255,   0,   0, 1.0); }
    #rRange::-moz-range-thumb     { box-shadow: -100rem 0 0 100rem rgba(255,   0,   0, 1.0); }
    
    #gRange                       { background-color:              rgba(  0, 255,   0, 0.2); }
    #gRange::-webkit-slider-thumb { box-shadow: -100rem 0 0 100rem rgba(  0, 255,   0, 1.0); }
    #gRange::-moz-range-thumb     { box-shadow: -100rem 0 0 100rem rgba(  0, 255,   0, 1.0); }
    
    #bRange                       { background-color:              rgba(  0,   0, 255, 0.3); }
    #bRange::-webkit-slider-thumb { box-shadow: -100rem 0 0 100rem rgba(  0,   0, 255, 1.0); }
    #bRange::-moz-range-thumb     { box-shadow: -100rem 0 0 100rem rgba(  0,   0, 255, 1.0); }
    

    #GlowBikeControlScreenModal {
        display: flex;
        flex-direction: column;
        justify-content: space-between;

        width: 50%;

        border: 1px solid black;

        visibility: hidden;
    }
    #GlowBikeControlScreenModal::backdrop {
        background-color: black;
        opacity: 0.7;
    }

</style>
    

<dialog id="GlowBikeControlScreenModal">
    <span></span>
    <br/>
    <br/>
    <button onclick="this.parentNode.close()">OK</button>
</dialog>

<div id="GlowBikeControlScreen" class="flex-vertical gap-between">

        <div class="inputRow gap-between">
            <input type='checkbox' class="placeholder">
            <div class="flex-vertical maximize">
                <input type='range' min='0' max='100' value='30' id='pctRange'>
            </div>
        </div>

        <div class="inputRow gap-between">
            <input type='checkbox' id='rCheck' checked>
            <div class="flex-vertical maximize">
                <input type='range' min='0' max='255' id='rRange'>
            </div>
        </div>
    
        <div class="inputRow gap-between">
            <input type='checkbox' id='gCheck' checked>
            <div class="flex-vertical maximize">
                <input type='range' min='0' max='255' id='gRange'>
            </div>
        </div>
    
        <div class="inputRow gap-between">
            <input type='checkbox' id='bCheck' checked>
            <div class="flex-vertical maximize">
                <input type='range' min='0' max='255' id='bRange'>
            </div>
        </div>

        <div id="colorwheel-container">
            <div id='colorwheel'></div>
        </div>
        
        <div class="inputRow gap-between">
            <input type='button' id='connectToggle' value='Connect'>
            <input type='button' id='bStartPause' value='Start'>
            <input type='button' id='bStop' value='Stop'>
        </div>
    </div>
    
<script>
'strict';



/////////////////////////////////////////////////////////////////////
// State
/////////////////////////////////////////////////////////////////////

let colorWheel;

domModal     = document.getElementById("GlowBikeControlScreenModal");
domModalText = this.domModal.childNodes[1];

let domCheckRed   = document.getElementById('rCheck');
let domCheckGreen = document.getElementById('gCheck');
let domCheckBlue  = document.getElementById('bCheck');

let domSliderBrightness = document.getElementById('pctRange');

let domSliderRed   = document.getElementById('rRange');
let domSliderGreen = document.getElementById('gRange');
let domSliderBlue  = document.getElementById('bRange');

let domConnect    = document.getElementById('connectToggle');
let domStartPause = document.getElementById('bStartPause');
let domStop       = document.getElementById('bStop');


/////////////////////////////////////////////////////////////////////
// Button Control
/////////////////////////////////////////////////////////////////////

class ConnectButton
{
    constructor()
    {
        this.isCanceled = false;
        this.isReconnect = false;

        this.state = "unconnected";

        glowBike.SetOnConnectedCallback(()    => { this.ChangeState("connected");   });
        glowBike.SetOnConnectFailCallback(()  => { this.ChangeState("unconnected"); });
        glowBike.SetOnDisconnectedCallback(() => { this.ChangeState("unconnected"); });
    }

    OnClick()
    {
        if (this.state == "unconnected")
        {
            this.isCanceled = false;
            this.isReconnect = false;
            this.ChangeState("connecting");
        }
        else
        {
            // user is:
            // - disconnecting an established connection
            // - cancelling an attempted connection
            // - cancelling a re-connection (looks the same as above)

            // in all cases, we will call disconnect and transition to the
            // unconnected state.
            // a callback to being disconnected later will be
            // for unconeccted -> unconnected
            this.isCanceled = true;

            glowBike.Disconnect();

            domConnect.value = "Connect";
            domConnect.style = "";

            this.state = "unconnected";
        }
    }

    async ChangeState(stateNew)
    {
        if (this.state == "unconnected" && stateNew == "connecting")
        {
            domConnect.value = "Connecting";
            domConnect.style = "background-color: yellow; border: yellow;";

            glowBike.Connect();

            this.state = stateNew;
        }
        else if (this.state == "connecting" && stateNew == "connected")
        {
            if (glowBike.GetRole() == "Leader")
            {
                domConnect.value = "Disconnect";
                domConnect.style = "background-color: green; border: green;";

                console.log(`Connected: ${glowBike.GetName()}`);

                glowBikeController = glowBike.GetControlService();

                // Trigger applying UI settings on connect
                if (this.isReconnect == false)
                {
                    setTimeout(() => {
                        OnSliderBrightnessChange();
                        OnCheckRedChange();
                        OnCheckGreenChange();
                        OnCheckBlueChange();

                        // auto-start on first connect
                        domStartPause.value = "Pause";
                        TransmitStart();
                    }, 50);
                }
                else
                {
                    setTimeout(() => {
                        OnSliderBrightnessChange();
                        OnCheckRedChange();
                        OnCheckGreenChange();
                        OnCheckBlueChange();
                    }, 50);
                }

                this.state = stateNew;
            }
            else
            {
                domConnect.value = "Connect";
                domConnect.style = "";

                console.log(`GlowBike wasn't Leader`);
                domModalText.innerHTML = `The selected device, ${glowBike.GetName()}, is not a Glow Bike Leader.<br/><br/>Please select the Glow Bike Leader device you wish to control.`;
                domModal.showModal();

                // notice the careful sequence here, state change first, then disconnect.
                // the disconnect will fire a callback, and we simply ignore going from
                // unconnected -> unconnected.
                this.state = "unconnected";
                
                glowBike.Disconnect();
            }
        }
        else if (this.state == "connecting" && stateNew == "unconnected")
        {
            domConnect.value = "Connect";
            domConnect.style = "";

            // only warn if a device was actually selected
            // (as opposed to just not picking one at all)
            if (this.isCanceled == false && glowBike.GetName() != "")
            {
                console.log(`Connect Failed`);
    
                domModalText.innerHTML = `Could not connect to selected device ${glowBike.GetName()}.<br/><br/>Please try again or select another device.`;
                domModal.showModal();
            }

            this.state = stateNew;
        }
        else if (this.state == "connected" && stateNew == "unconnected")
        {
            domConnect.value = "Connecting";
            domConnect.style = "background-color: yellow; border: yellow;";
            
            console.log(`Connection Lost, auto-re-connection`);
            this.isReconnect = true;

            glowBikeController = null;

            this.state = "connecting";
        }
    }
}

let connectButton;

async function SetupButtons()
{
    if (connectButton == null)
    {
        connectButton = new ConnectButton();
    }

    domConnect.addEventListener('click', e => {
        connectButton.OnClick();
    });

    domStartPause.addEventListener('click', e => {
        if (domStartPause.value == "Start")
        {
            TransmitStart();
            domStartPause.value = "Pause";
        }
        else
        {
            TransmitPause();
            domStartPause.value = "Start";
        }
    });

    domStop.addEventListener('click', e => {
        TransmitStop();

        domStartPause.value = "Start";
    });
}


/////////////////////////////////////////////////////////////////////
// Message sending
/////////////////////////////////////////////////////////////////////

let queue = [];

let count = 0;

async function Send(cmd)
{
    if (glowBikeController == null) return;

    let obj = {
        type: "SHELL_COMMAND",
        cmd: cmd,
    };

    let objJson = JSON.stringify(obj)

    queue.push(objJson);

    if (queue.length == 1)
    {
        while (queue.length)
        {
            let objJsonSend = queue[0];
            
            try
            {
                // console.log(`sending ${objJsonSend}`);
                await glowBikeController.Send(objJsonSend);
            }
            catch (e)
            {
                console.log(`Send issue: ${e}`);
            }

            queue.shift();
        }
    }
}

function TransmitRGB()
{
    Send(`glow.rgb ${domSliderRed.value} ${domSliderGreen.value} ${domSliderBlue.value}`);
}

function TransmitPct(pct)
{
    Send(`glow.pct ${pct}`);
}

function TransmitRed()
{
    Send(`glow.mrl ${domSliderRed.value}`);
}

function TransmitGreen()
{
    Send(`glow.mgl ${domSliderGreen.value}`);
}

function TransmitBlue()
{
    Send(`glow.mbl ${domSliderBlue.value}`);
}

function TransmitRedAutomatic()
{
    Send("glow.mro");
}

function TransmitGreenAutomatic()
{
    Send("glow.mgo");
}

function TransmitBlueAutomatic()
{
    Send("glow.mbo");
}

function TransmitStart()
{
    Send("glow.start");
}

function TransmitPause()
{
    Send("glow.pause");
}

function TransmitStop()
{
    Send("glow.stop");
}


/////////////////////////////////////////////////////////////////////
// Color Input Handling
/////////////////////////////////////////////////////////////////////

function OnWheelChange(r, g, b)
{
    domCheckRed.checked   = false;
    domCheckGreen.checked = false;
    domCheckBlue.checked  = false;
    
    domSliderRed.value   = r;
    domSliderGreen.value = g;
    domSliderBlue.value  = b;

    TransmitRGB();
}

function OnSliderBrightnessChange()
{
    TransmitPct(domSliderBrightness.value);
}

let IN_SLIDER_CALLBACK = false;
function SetWheelColorFromSliders()
{
    IN_SLIDER_CALLBACK = true;

    colorWheel.rgb = [
        domSliderRed.value,
        domSliderGreen.value,
        domSliderBlue.value,
    ];

    IN_SLIDER_CALLBACK = false;
}

function OnSliderRedChange()
{
    domCheckRed.checked = false;
    SetWheelColorFromSliders();
    TransmitRed();
}

function OnSliderGreenChange()
{
    domCheckGreen.checked = false;
    SetWheelColorFromSliders();
    TransmitGreen();
}

function OnSliderBlueChange()
{
    domCheckBlue.checked = false;
    SetWheelColorFromSliders();
    TransmitBlue();
}

// Transition control back to the slider by pretending an event fired
function OnCheckRedChange()
{
    if (domCheckRed.checked) { TransmitRedAutomatic(); } else { OnSliderRedChange(); }
}

function OnCheckGreenChange()
{
    if (domCheckGreen.checked) { TransmitGreenAutomatic(); } else { OnSliderGreenChange(); }
}

function OnCheckBlueChange()
{
    if (domCheckBlue.checked) { TransmitBlueAutomatic(); } else { OnSliderBlueChange(); }
}




/////////////////////////////////////////////////////////////////////
// Init
/////////////////////////////////////////////////////////////////////

let RGB_START = [200, 40, 200];

function SetupColorWheel()
{
    let c = document.getElementById('colorwheel-container');

    let wheelDiameter = Math.max(c.offsetHeight, c.offsetWidth);

    colorWheel = new ReinventedColorWheel({
        appendTo: document.getElementById("colorwheel"),

        // initial color (can be specified in hsv / hsl / rgb / hex)
        rgb: RGB_START,

        // appearance
        wheelDiameter: wheelDiameter,
        wheelThickness: 50,
        handleDiameter: 50,
        wheelReflectsSaturation: false,

        // on change
        onChange: (color) => {
            if (IN_SLIDER_CALLBACK == false)
            {
                OnWheelChange(color.rgb[0], color.rgb[1],  color.rgb[2]);
            }
        },
    });
}

function SetupRanges()
{
    domSliderBrightness.addEventListener('input', e => { OnSliderBrightnessChange(); })

    domSliderRed.addEventListener('input',   e => { OnSliderRedChange();   });
    domSliderGreen.addEventListener('input', e => { OnSliderGreenChange(); });
    domSliderBlue.addEventListener('input',  e => { OnSliderBlueChange();  });

    domSliderRed.value   = RGB_START[0];
    domSliderGreen.value = RGB_START[1];
    domSliderBlue.value  = RGB_START[2];
}

function SetupChecks()
{
    domCheckRed.addEventListener('change',   e => { OnCheckRedChange()   });
    domCheckGreen.addEventListener('change', e => { OnCheckGreenChange() });
    domCheckBlue.addEventListener('change',  e => { OnCheckBlueChange()  });
}

function SetupHeights()
{
    let gbcContainer = document.getElementById("GlowBikeControlScreen");

    // How tall are the rows?
    let rowList = gbcContainer.getElementsByClassName("inputRow");
    let height = rowList[0].offsetHeight;

    // let the menu know about this also
    MENU_HEIGHT = height;

    let inputList = gbcContainer.getElementsByTagName("input");
    for (let input of inputList)
    {
        if (input.type == "checkbox")
        {
            input.style.height = `${height}px`;
            input.style.width  = `${height}px`;
        }
        else if (input.type == "range")
        {
            input.style.height = `${height}px`;
        }
    }
}

function SetupGlowBikeControlScreen()
{
    SetupColorWheel();
    SetupRanges();
    SetupChecks();
    SetupHeights();
    SetupButtons();
}

function StartGlowBikeControlScreen()
{
    console.log(`Starting Control Screen`);
}

function StopGlowBikeControlScreen()
{
    console.log(`Stopping Control Screen`);

    if (domConnect.value != "Connect")
    {
        console.log(`  Calling Disconnect/Cancel`);
        domConnect.click();
    }
}
</script>


































<script>
'strict';

window.addEventListener('DOMContentLoaded', e => {
    SetupGlowBikeConfigurationScreen();
    SetupGlowBikeControlScreen();
    SetupMenu();

    SwitchTo("Control");
});
</script>



    

</body>
</html>








